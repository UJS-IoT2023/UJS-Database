1. 检索购买图书B4最多的图书馆名；

```sql
SELECT library_id FROM book_distribution
WHERE book_id = 'B4'
ORDER BY quantity
LIMIT 1;
```

| library\_id |
| :--- |
| L4 |

2. 取出已经发行的图书中最贵和最便宜的书的书名和定价；

```sql
SELECT book_name, price, price_rank
FROM (
    SELECT book.book_name, book.price,
        CASE 
            WHEN book.price = MAX(book.price) OVER() THEN 'HIGHEST'
            WHEN book.price = MIN(book.price) OVER() THEN 'LOWEST'
        END as price_rank
    FROM book
    WHERE EXISTS (
        SELECT 1
        FROM book_distribution
        WHERE book_distribution.book_id = book.book_id
    )
) ranked
WHERE price_rank IS NOT NULL
ORDER BY price DESC;
```

| book\_name | price | price\_rank |
| :--- | :--- | :--- |
| 数据库原理 | 9.80 | HIGHEST |
| 操作系统 | 6.00 | LOWEST |

3. 检索销售图书数量最多的书店名；

```sql
SELECT s.shop_id, s.shop_name, s.address, COALESCE(SUM(d.quantity), 0) AS total_books_sold
FROM shop s
LEFT JOIN book_distribution d ON s.shop_id = d.shop_id
GROUP BY s.shop_id, s.shop_name, s.address
ORDER BY total_books_sold DESC
LIMIT 1;
```

| shop\_id | shop\_name | address | total\_books\_sold |
| :--- | :--- | :--- | :--- |
| S5 | 江苏新华书店 | 南京 | 200 |


4. 输出如下报表

|        |         |        |        |
| ------ | ------- | ------ | ------ |
| **书店** | **图书馆** | **图书** | **数量** |

```sql
SELECT 
    s.shop_name AS "书店",
    l.library_name AS "图书馆", 
    b.book_name AS "图书",
    bd.quantity AS "数量"
FROM book_distribution bd
INNER JOIN shop s ON bd.shop_id = s.shop_id
INNER JOIN library l ON bd.library_id = l.library_id
INNER JOIN book b ON bd.book_id = b.book_id
ORDER BY s.shop_name, l.library_name, b.book_name;
```

| 书店 | 图书馆 | 图书 | 数量 |
| :--- | :--- | :--- | :--- |
| 上海外文书店 | 上海图书馆 | 数据库设计 | 5 |
| 上海外文书店 | 上海外文书店 | 数据库原理 | 10 |
| 上海新华书店 | 上海图书馆 | 数据库原理 | 10 |
| 上海新华书店 | 南京图书馆 | 数据库原理 | 10 |
| 北京新华书店 | 上海图书馆 | 系统分析与设计 | 5 |
| 江苏新华书店 | 上海图书馆 | 计算机原理 | 50 |
| 江苏新华书店 | 上海外文书店 | 计算机原理 | 50 |
| 江苏新华书店 | 南京图书馆 | 系统分析与设计 | 50 |
| 江苏新华书店 | 南京图书馆 | 计算机原理 | 50 |
| 湖北新华书店 | 上海外文书店 | 操作系统 | 15 |
| 湖北新华书店 | 武汉图书馆 | 操作系统 | 30 |
| 湖北新华书店 | 武汉图书馆 | 计算机原理 | 20 |

