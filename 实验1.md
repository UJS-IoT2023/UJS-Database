# 实验一

## 实验目的

要求学生熟练掌握和使用T－SQL﹑SQL
Server企业管理器创建数据库﹑基本表﹑视图﹑索引和修改表结构，及向数据库输入数据的操作；学会创建和使用表的主码、外码和约束。

## 实验要求

本实验针对上述两个题目分别完成以下相应任务：

1. 创建相应的数据库和查看数据库属性；
2. 创建基本表﹑确定表的主码和相应的约束，为主码建索引；
3. 创建﹑查看视图；
4. 利用T－SQL和SQL Server Management Studio 向数据库输入数据。

## 实验步骤

首先创建数据库

```sql
CREATE DATABASE supply_chain;
```

创建数据表并建立索引

```sql
-- Suppliers Table
CREATE TABLE Suppliers (
    supplier_id TEXT PRIMARY KEY,
    supplier_name TEXT NOT NULL,
    status INTEGER NOT NULL,
    city TEXT NOT NULL
);
CREATE INDEX idx_suppliers_supplier_id ON Suppliers (supplier_id);

-- Parts Table
CREATE TABLE Parts (
    part_id TEXT PRIMARY KEY,
    part_name TEXT NOT NULL,
    color TEXT NOT NULL,
    weight INTEGER NOT NULL
);
CREATE INDEX idx_parts_part_id ON Parts (part_id);

-- Projects Table
CREATE TABLE Projects (
    project_id TEXT PRIMARY KEY,
    project_name TEXT NOT NULL,
    city TEXT NOT NULL
);
CREATE INDEX idx_projects_project_id ON Projects (project_id);

-- SupplierPartProject Junction Table
CREATE TABLE SupplierPartProject (
    supplier_id TEXT,
    part_id TEXT,
    project_id TEXT,
    quantity INTEGER NOT NULL,
    PRIMARY KEY (supplier_id, part_id, project_id),
    FOREIGN KEY (supplier_id) REFERENCES Suppliers (supplier_id),
    FOREIGN KEY (part_id) REFERENCES Parts (part_id),
    FOREIGN KEY (project_id) REFERENCES Projects (project_id)
);
CREATE INDEX idx_spj_supplier_id ON SupplierPartProject (supplier_id);
CREATE INDEX idx_spj_part_id ON SupplierPartProject (part_id);
CREATE INDEX idx_spj_project_id ON SupplierPartProject (project_id);
```

插入种子数据

```sql
-- Insert into Suppliers
INSERT INTO Suppliers (supplier_id, supplier_name, status, city) VALUES
('S1', '精益', 20, '天津'),
('S2', '盛锡', 10, '北京'),
('S3', '东方红', 30, '北京'),
('S4', '丰泰盛', 20, '天津'),
('S5', '为民', 30, '上海');

-- Insert into Parts
INSERT INTO Parts (part_id, part_name, color, weight) VALUES
('P1', '螺母', '红', 12),
('P2', '螺栓', '绿', 17),
('P3', '螺丝刀', '蓝', 14),
('P4', '螺丝刀', '红', 14),
('P5', '凸轮', '蓝', 40),
('P6', '齿轮', '红', 30);

-- Insert into Projects
INSERT INTO Projects (project_id, project_name, city) VALUES
('J1', '三建', '北京'),
('J2', '一汽', '长春'),
('J3', '弹簧厂', '天津'),
('J4', '造船厂', '天津'),
('J5', '机车厂', '唐山'),
('J6', '无线电厂', '常州'),
('J7', '半导体厂', '南京');

-- Insert into SupplierPartProject
INSERT INTO SupplierPartProject (supplier_id, part_id, project_id, quantity) VALUES
('S1', 'P1', 'J1', 200),
('S1', 'P1', 'J3', 100),
('S1', 'P1', 'J4', 700),
('S1', 'P2', 'J2', 100),
('S2', 'P3', 'J1', 400),
('S2', 'P3', 'J2', 200),
('S2', 'P3', 'J4', 500),
('S2', 'P3', 'J5', 400),
('S2', 'P5', 'J1', 400),
('S2', 'P5', 'J2', 100),
('S3', 'P1', 'J1', 200),
('S3', 'P3', 'J1', 200),
('S4', 'P5', 'J1', 100),
('S4', 'P6', 'J3', 300),
('S4', 'P6', 'J4', 200),
('S5', 'P2', 'J4', 100),
('S5', 'P3', 'J1', 200),
('S5', 'P6', 'J2', 200),
('S5', 'P6', 'J4', 500);
```

创建视图

```sql
CREATE VIEW SupplierPartProjectView AS
    SELECT
        s.supplier_id, s.supplier_name, s.city AS supplier_city,
        p.part_id, p.part_name, p.color, p.weight,
        j.project_id, j.project_name, j.city AS project_city,
        spj.quantity
    FROM Suppliers s
    JOIN SupplierPartProject spj ON s.supplier_id = spj.supplier_id
    JOIN Parts p ON spj.part_id = p.part_id
    JOIN Projects j ON spj.project_id = j.project_id;
```

## 实验结果

查看视图

```sql
-- View the data
SELECT * FROM SupplierPartProjectView LIMIT 5;
```

| supplier\_id | supplier\_name | supplier\_city | part\_id | part\_name | color | weight | project\_id | project\_name | project\_city | quantity |
|:------------ |:-------------- |:-------------- |:-------- |:---------- |:----- |:------ |:----------- |:------------- |:------------- |:-------- |
| S1           | 精益             | 天津             | P1       | 螺母         | 红     | 12     | J1          | 三建            | 北京            | 200      |
| S1           | 精益             | 天津             | P1       | 螺母         | 红     | 12     | J3          | 弹簧厂           | 天津            | 100      |
| S1           | 精益             | 天津             | P1       | 螺母         | 红     | 12     | J4          | 造船厂           | 天津            | 700      |
| S1           | 精益             | 天津             | P2       | 螺栓         | 绿     | 17     | J2          | 一汽            | 长春            | 100      |
| S2           | 盛锡             | 北京             | P3       | 螺丝刀        | 蓝     | 14     | J1          | 三建            | 北京            | 400      |

## 实验小结

1. 为什么要建立索引？在你的数据库中建立多少索引合适？
   
   索引可以显著提高数据库查询的性能，通过索引快速定位数据而不是扫描。在上面四个表中包括四个主键是必须的，还有在 `SupplierPartProject` 上的三个外键索引适合频繁的 `JOIN` 操作。

2. 索引和视图能否修改吗？为什么？
   
   - 索引不可直接修改，但是可以通过 `DROP` 删除后创建而间接修改。
   
   - 视图是否可以修改取决于视图定义，涉及到多表操作的视图无法修改。

3. 为什么不能随意删除被参考表中的主码？
   
   被参考表中的主码属于外键，被其他数据关联，若随意删除会造成数据失去关联。大部分数据库中若存在外键约束都不能随意删除被引用的数据。
