# 实验三 数据库的维护

## 实验要求

1. 把全部红色零件颜色改为粉红色；

2. 由S1供给J1的零件P1今改为由S2供应，作必要修改；

3. 删去全部蓝色零件及相应的SPJ记录；

4. 把全部螺母的重量置为0；

5. 为SPJ表的QTY字段设计CHECK约束：0〈 QTY〈1000；

6. 实现对SPJ表的操作权限管理的使用。

## 实验内容

**将红色零件改为粉红色**

```sql
UPDATE parts
SET color = '粉红'
WHERE color = '红';
```

```
[2025-10-23 10:46:48] 3 rows affected in 8 ms
```

**由 S1 提供给 J1 的零件 P1 改为 S2 供应**

```sql
UPDATE supplier_part_project
SET supplier_id = 'S2'
WHERE supplier_id = 'S1' AND part_id = 'P1' AND project_id = 'J1';
```

```
[2025-10-23 10:51:47] 1 row affected in 16 ms
```

**删去全部蓝色零件及相应的 SPJ 记录**

```sql
BEGIN;

DELETE FROM supplier_part_project
WHERE part_id IN (
    SELECT part_id
    FROM parts
    WHERE color = '蓝'
    );

DELETE FROM parts
WHERE color = '蓝';

COMMIT;
```

```
[2025-10-23 11:01:09] 9 rows affected in 5 ms
[2025-10-23 11:01:09] 2 rows affected in 5 ms
[2025-10-23 11:01:09] completed in 5 ms
```

**修改零件螺母的重量为 0**

```sql
UPDATE parts
SET weight = 0
WHERE part_name = '螺母';
```

```
[2025-10-23 11:19:44] 1 row affected in 28 ms
```

| part\_id | part\_name | color | weight |
|:-------- |:---------- |:----- |:------ |
| P2       | 螺栓         | 绿     | 17     |
| P4       | 螺丝刀        | 粉红    | 14     |
| P6       | 齿轮         | 粉红    | 30     |
| P1       | 螺母         | 粉红    | 0      |

**添加约束**

```sql
ALTER TABLE supplier_part_project
ADD CONSTRAINT quantity_range
CHECK ( quantity > 0 AND quantity < 1000 );
```

```
[2025-10-23 11:24:24] completed in 9 ms
```

此时查看本表的定义

```
supply_chain=# \d supplier_part_project 
          Table "public.supplier_part_project"
   Column    |  Type   | Collation | Nullable | Default 
-------------+---------+-----------+----------+---------
 supplier_id | text    |           | not null | 
 part_id     | text    |           | not null | 
 project_id  | text    |           | not null | 
 quantity    | integer |           | not null | 
Indexes:
    "supplierpartproject_pkey" PRIMARY KEY, btree (supplier_id, part_id, project_id)
    "idx_spj_part_id" btree (part_id)
    "idx_spj_project_id" btree (project_id)
    "idx_spj_supplier_id" btree (supplier_id)
Check constraints:
    "quantity_range" CHECK (quantity > 0 AND quantity < 1000)
Foreign-key constraints:
    "supplierpartproject_part_id_fkey" FOREIGN KEY (part_id) REFERENCES parts(part_id)
    "supplierpartproject_project_id_fkey" FOREIGN KEY (project_id) REFERENCES projects(project_id)
    "supplierpartproject_supplier_id_fkey" FOREIGN KEY (supplier_id) REFERENCES suppliers(supplier_id)
```

**权限控制**

通过创建特定用户并赋予用户特定的权限来实现权限控制。

```sql
CREATE USER user_a WITH PASSWORD '123456';
CREATE USER user_b WITH PASSWORD '123456';
GRANT SELECT ON supplier_part_project TO user_a;
GRANT SELECT, INSERT, UPDATE, DELETE ON supplier_part_project TO user_b;
```

```
[2025-10-28 10:32:11] Connected to supply_chain
[2025-10-28 10:32:11] completed in 767 ms
supply_chain> CREATE USER user_a WITH PASSWORD '123456'
[2025-10-28 10:33:08] completed in 11 ms
supply_chain> CREATE USER user_b WITH PASSWORD '123456'
[2025-10-28 10:33:08] completed in 8 ms
supply_chain> GRANT SELECT ON supplier_part_project TO user_a
[2025-10-28 10:33:08] completed in 5 ms
supply_chain> GRANT SELECT, INSERT, UPDATE, DELETE ON supplier_part_project TO user_b
[2025-10-28 10:33:08] completed in 4 ms
```
